fragment AuthorProfile on Profile {
  affiliations
  email
  fullname
  nickname
  picture
  userId
}

fragment ForumPost on Post {
  id
  authorProfile {
    ...AuthorProfile
  }
  createdAt
  hiddenByModerator
  message
  topicId
}

fragment RecentPost on Post {
  ...ForumPost
  blurb
  topic {
    id
    postsCount
    title
    sticky
    forum {
      id
      name
    }
    participantCount
    participantsConnection(first: 4) {
      nodes {
        ...AuthorProfile
      }
    }
  }
}

query Forums($slug: String!) {
  me {
    id
    profile {
      ...AuthorProfile
    }
  }
  projectBySlug(slug: $slug) {
    id
    sessionParticipationStatus
    forums {
      id
      archived
      name
      description
      topicCount
      postCount
      lastPostDate
      canPost
    }
    latestPostsConnection(first: 5) {
      nodes {
        ...RecentPost
      }
    }
  }
}

fragment ForumTopic on Topic {
  id
  title
  authorProfile {
    ...AuthorProfile
  }
  createdAt
  locked
  sticky
  postsCount
  lastPostDate
  blurb
  forumId
  participantCount
  participantsConnection(first: 5) {
    nodes {
      userId
      email
      picture
      fullname
      nickname
    }
  }
}

query TopicList($forumId: Int!) {
  forum(id: $forumId) {
    id
    archived
    name
    description
    topicCount
    postCount
    lastPostDate
    project {
      id
      sessionParticipationStatus
    }
    canPost
    topicsConnection(orderBy: LAST_POST_CREATED_AT_AND_STICKY) {
      nodes {
        ...ForumTopic
      }
    }
  }
}

mutation CreateTopic($forumId: Int!, $content: JSON, $title: String!) {
  createTopic(input: { forumId: $forumId, message: $content, title: $title }) {
    topic {
      ...ForumTopic
      postsCount
      lastPostDate
    }
    forum {
      id
      topicCount
      postCount
      lastPostDate
    }
  }
}

query BreadcrumbTopic($topicId: Int!) {
  topic(id: $topicId) {
    id
    title
  }
}

query TopicDetail($id: Int!) {
  topic(id: $id) {
    ...ForumTopic
    postsConnection(orderBy: ID_ASC) {
      nodes {
        ...ForumPost
        message
      }
    }
    forum {
      id
      canPost
      project {
        id
        sessionParticipationStatus
      }
    }
  }
  me {
    id
    profile {
      ...AuthorProfile
    }
  }
}

mutation CreateReply($topicId: Int!, $content: JSON) {
  createPost(input: { topicId: $topicId, message: $content }) {
    post {
      ...ForumPost
      topic {
        ...ForumTopic
        forum {
          id
          postCount
          topicCount
          lastPostDate
        }
      }
    }
  }
}
